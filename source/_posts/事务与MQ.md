title: 事务与MQ
date: 2016-09-02 23:08:36
categories: 编程
tags: MQ
---

这周遇到一个诡异的问题。

简要描述：

> 客户将资金转入到加息计划中，程序会判断这笔转入是否是用户首次加息，如果是，用户会享受奖励。

逻辑就是这样的，代码为了解耦和，在客户加入加息计划的方法**内**发了一个消息，整个方法加了一个**事务**。<!--more-->

然后问题来了：
> 测试反馈偶尔有用户首次加入加息计划后，没有收到对应的奖励

怎么会这样呢？我刚开始以为是不是谁动了数据，但是过了一天，同样的问题又出现了。这就说明代码有问题，需要解决。

此处略去1000字。。。 

问题原因：
> 在外层事务方法中，mysql生成一条加息计划记录，但是这时候事务还没有提交，消息却发出去了，然后方法执行完毕，事务提交，写入数据库。问题在于消息是异步的，到达消息消费者时间不确定，有可能在事务提交之前就开始处理了。看懂了没，也就是说事务还没提交，mysql中的数据还没落库，在消费者中已经开始查询mysql中的数据了。当然就查不到啊！！！

结论：
> rabbitMQ速度真快。开玩笑，结论是最好不要在事务方法中使用MQ。

解决方案：
> 去掉最外层的事务，新写一个本地service，这个service与之前的方法完全一样，除了不发MQ，然后在最外层方法中调用这个service，然后发Q

改了之后，测试反馈问题不再复现了。

这是个坑，需要留意。